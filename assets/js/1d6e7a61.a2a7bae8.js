"use strict";(self.webpackChunkvirtalis_docs=self.webpackChunkvirtalis_docs||[]).push([[1904],{76899:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"virtalis-hub-system-admin/configure/automated-backup","title":"Automated Backup System","description":"Virtalis Hub comes with an automated back up system that allows you to restore to an earlier snapshot in the event of a disaster. We will install Velero to back up the state of your Kubernetes Cluster and uses a custom built solution which leverages Restic to back up the persistent data imported into Virtalis Hub.","source":"@site/docs/virtalis-hub-system-admin/configure/automated-backup.mdx","sourceDirName":"virtalis-hub-system-admin/configure","slug":"/virtalis-hub-system-admin/configure/automated-backup","permalink":"/virtalis-hub-system-admin/configure/automated-backup","draft":false,"unlisted":false,"editUrl":"https://github.com/virtalis/docs/tree/master/docs/virtalis-hub-system-admin/configure/automated-backup.mdx","tags":[],"version":"current","lastUpdatedAt":1740107398000,"frontMatter":{},"sidebar":"virtalisHubSystemAdminSidebar","previous":{"title":"Authentication with External Systems","permalink":"/virtalis-hub-system-admin/configure/authentication"},"next":{"title":"Change the Domain of an Existing Installation","permalink":"/virtalis-hub-system-admin/configure/change-domain"}}');var s=r(74848),o=r(28453);const i={},a="Automated Backup System",l={},c=[{value:"Set Up the Deployment Shell",id:"set-up-the-deployment-shell",level:2},{value:"Installation",id:"installation",level:2},{value:"Creating a StorageLocation",id:"creating-a-storagelocation",level:3},{value:"Set Up Variables",id:"set-up-variables",level:2},{value:"Velero Installation",id:"velero-installation",level:2},{value:"Restic Integration",id:"restic-integration",level:2},{value:"Triggering a Manual Backup",id:"triggering-a-manual-backup",level:2},{value:"Restoring Data",id:"restoring-data",level:2},{value:"Restoration Plan",id:"restoration-plan",level:3},{value:"Run the Restore Script",id:"run-the-restore-script",level:3},{value:"Pruning Backups",id:"pruning-backups",level:2},{value:"Velero",id:"velero",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"automated-backup-system",children:"Automated Backup System"})}),"\n",(0,s.jsxs)(n.p,{children:["Virtalis Hub comes with an automated back up system that allows you to restore to an earlier snapshot in the event of a disaster. We will install ",(0,s.jsx)(n.a,{href:"https://velero.io/docs/v1.5/index.html",children:"Velero"})," to back up the state of your Kubernetes Cluster and uses a custom built solution which leverages ",(0,s.jsx)(n.a,{href:"https://restic.readthedocs.io/en/stable/",children:"Restic"})," to back up the persistent data imported into Virtalis Hub."]}),"\n",(0,s.jsx)(n.p,{children:"You should consider creating regular backups of your buckets which hold the backed-up data in case of failure. This will bed one through your cloud provider or manually if you host your own bucket."}),"\n",(0,s.jsx)(n.p,{children:"Alternatively, you can consider using your own backup solution. A good option is the Persistent Volume Snapshot which creates a snapshot of a persistent volume at a point in time. The biggest caveat is that they\u2019re only supported on a number of platforms such as Azure and AWS."}),"\n",(0,s.jsx)(n.p,{children:"If you opt in for a different solution to the one we provide, you have to be mindful of the fact that not all databases used by Virtalis Hub support live backups. This means that the databases have to be taken offline before backing up."}),"\n",(0,s.jsx)(n.p,{children:"The following databases in use by Virtalis Hub must be taken offline for the duration of the backup:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Minio"}),"\n",(0,s.jsx)(n.li,{children:"Neo4j"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"set-up-the-deployment-shell",children:"Set Up the Deployment Shell"}),"\n",(0,s.jsx)(n.p,{children:"Export the variable:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export HUB_NAMESPACE=hub\n"})}),"\n",(0,s.jsx)(n.p,{children:"Navigate to the directory containing Virtalis Hub installation files:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"cd /home/root/Hub/k8s\n"})}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.h3,{id:"creating-a-storagelocation",children:"Creating a StorageLocation"}),"\n",(0,s.jsx)(n.p,{children:"Recommended:"}),"\n",(0,s.jsx)(n.p,{children:"Follow the \u201cCreate S3 Bucket\u201d and \u201cSet permissions for Velero\u201d sections from the link below and ensure that you create the following 2 buckets under your s3 bucket:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"hub-restic"}),"\n",(0,s.jsx)(n.li,{children:"hub-velero"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"GitHub - vmware-tanzu/velero-plugin-for-aws: Plugins to support Velero on AWS"}),"\n",(0,s.jsx)(n.p,{children:"Export the address and port of the bucket you have created:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export S3_BUCKET_ADDRESS=<address>\r\n#i.e S3_BUCKET_ADDRESS=192.168.1.3, S3_BUCKET_ADDRESS=mydomain.com\r\nexport S3_BUCKET_PORT=<port>\r\nexport S3_BUCKET_PROTOCOL=<http or https>\r\nexport S3_BUCKET_REGION=<region>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Not recommended - create an s3 bucket on the same cluster, alongside Virtalis Hub:"}),"\n",(0,s.jsx)(n.p,{children:"Customize the persistence.size if the total size of your data exceeds 256gb and change the storage class HUB_SC if needed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export HUB_SC=local-path\r\nkubectl create ns hub-backup\r\n\r\n#check if pwgen is installed for the next step\r\ncommand -v pwgen\r\n\r\nkubectl create secret generic hub-s3-backup -n hub-backup \\\r\n--from-literal='access-key'=$(pwgen 30 1 -s | tr -d '\\n') \\\r\n--from-literal='secret-key'=$(pwgen 30 1 -s | tr -d '\\n')\r\n\r\nhelm upgrade --install hub-s3-backup bitnami/minio \\\r\n-n hub-backup --version 3.6.1 \\\r\n--set persistence.storageClass=$HUB_SC \\\r\n--set persistence.size=256Gi \\\r\n--set mode=standalone \\\r\n--set resources.requests.memory='150Mi' \\\r\n--set resources.requests.cpu='250m' \\\r\n--set resources.limits.memory='500Mi' \\\r\n--set resources.limits.cpu='500m' \\\r\n--set disableWebUI=true \\\r\n--set useCredentialsFile=true \\\r\n--set volumePermissions.enabled=true \\\r\n--set defaultBuckets=\"hub-velero hub-restic\" \\\r\n--set global.minio.existingSecret=hub-s3-backup\r\n\r\ncat <<EOF > credentials-velero\r\n[default]\r\naws_access_key_id=$(kubectl get secret hub-s3-backup \\\r\n-n hub-backup -o jsonpath=\"{.data.access-key}\" | base64 --decode)\r\naws_secret_access_key=$(kubectl get secret hub-s3-backup \\\r\n-n hub-backup -o jsonpath=\"{.data.secret-key}\" | base64 --decode)\r\nEOF\n"})}),"\n",(0,s.jsx)(n.p,{children:"Export the address and port of the bucket you have created:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export S3_BUCKET_ADDRESS=hub-s3-backup-minio.hub-backup.svc.cluster.local\r\nexport S3_BUCKET_PORT=9000\r\nexport S3_BUCKET_PROTOCOL=http\r\nexport S3_BUCKET_REGION=local\n"})}),"\n",(0,s.jsx)(n.h2,{id:"set-up-variables",children:"Set Up Variables"}),"\n",(0,s.jsx)(n.p,{children:"For the duration of this installation, you must navigate to the k8s folder that is downloadable by following the Virtalis Hub Installation Guide."}),"\n",(0,s.jsx)(n.p,{children:"Make scripts executable:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"sudo chmod +x \\\r\ntrigger-database-restore.sh \\\r\ntrigger-database-backup.sh \\\r\ntrigger-database-backup-prune.sh \\\r\ninstall-backup-restore.sh\n"})}),"\n",(0,s.jsx)(n.p,{children:"Export the following variables:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export ACR_REGISTRY_NAME=virtaliscustomer\n"})}),"\n",(0,s.jsx)(n.p,{children:"Export the address of the hub-restic bucket:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export REPO_URL=s3:$S3_BUCKET_PROTOCOL://\\\r\n$S3_BUCKET_ADDRESS:$S3_BUCKET_PORT/hub-restic\n"})}),"\n",(0,s.jsx)(n.p,{children:"Optional configuration variables:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export MANAGED_TAG=<custom image tag for Virtalis Hub services>\r\nexport DISABLE_CRON<seto to true to install without an automated cronSchedule>\n"})}),"\n",(0,s.jsx)(n.h2,{id:"velero-installation",children:"Velero Installation"}),"\n",(0,s.jsx)(n.p,{children:"The following steps will assume you named your Velero bucket \u201chub-velero\u201d."}),"\n",(0,s.jsx)(n.p,{children:"Add the VMware helm repository and update:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"helm repo add vmware-tanzu https://vmware-tanzu.github.io/helm-charts\r\nhelm repo update\n"})}),"\n",(0,s.jsx)(n.p,{children:"Install Velero:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"helm install velero vmware-tanzu/velero \\\r\n--namespace velero \\\r\n--create-namespace \\\r\n--set-file credentials.secretContents.cloud\\\r\n=./credentials-velero \\\r\n--set configuration.provider=aws \\\r\n--set configuration.backupStorageLocation.name\\\r\n=hub-velero \\\r\n--set configuration.backupStorageLocation.bucket\\\r\n=hub-velero \\\r\n--set configuration.backupStorageLocation.config.region\\\r\n=$S3_BUCKET_REGION \\\r\n--set configuration.backupStorageLocation.config.s3Url\\\r\n=$S3_BUCKET_PROTOCOL://$S3_BUCKET_ADDRESS:$S3_BUCKET_PORT \\\r\n--set configuration.backupStorageLocation.config.publicUrl\\\r\n=$S3_BUCKET_PROTOCOL://$S3_BUCKET_ADDRESS:$S3_BUCKET_PORT \\\r\n--set configuration.backupStorageLocation.config.s3ForcePathStyle\\\r\n=true \\\r\n--set initContainers[0].name=velero-plugin-for-aws \\\r\n--set initContainers[0].image=velero/velero-plugin-for-aws:v1.1.0 \\\r\n--set initContainers[0].volumeMounts[0].mountPath=/target \\\r\n--set initContainers[0].volumeMounts[0].name=plugins \\\r\n--set snapshotsEnabled=false \\\r\n--version 2.23.1 \\\r\n--set deployRestic=true\n"})}),"\n",(0,s.jsx)(n.p,{children:"Install the velero cli client:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"wget https://github.com/vmware-tanzu/velero/releases\\\r\n/download/v1.5.3/velero-v1.5.3-linux-amd64.tar.gz\r\ntar -xzvf velero-v1.5.3-linux-amd64.tar.gz\r\nrm -f velero-v1.5.3-linux-amd64.tar.gz\r\nsudo mv $(pwd)/velero-v1.5.3-linux-amd64/velero /usr/bin/\r\nsudo chmod +x /usr/bin/velero\n"})}),"\n",(0,s.jsx)(n.p,{children:"Manually create a single backup to verify that the connection to the aws bucket is working:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"velero backup create test-backup-1 \\\r\n--storage-location=hub-velero --include-namespaces $HUB_NAMESPACE\n"})}),"\n",(0,s.jsx)(n.p,{children:"Watch the status of the backup until it\u2019s finished, this should show up as complete if everything was set up correctly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"watch -n2 velero backup get\n"})}),"\n",(0,s.jsx)(n.p,{children:"Create a scheduled backup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'velero create schedule cluster-backup --schedule="45 23 * * 6" \\\r\n--storage-location=hub-velero --include-namespaces $HUB_NAMESPACE\n'})}),"\n",(0,s.jsx)(n.p,{children:"This schedule will run a backup every Saturday at 23:45PM."}),"\n",(0,s.jsx)(n.h2,{id:"restic-integration",children:"Restic Integration"}),"\n",(0,s.jsx)(n.p,{children:"The custom restic integration uses Kubernetes jobs to mount the data, encrypt it, and send it to a bucket. Kubernetes Custom Resource Definitions are used to store the information about the resticre positories as well as any created backups."}),"\n",(0,s.jsxs)(n.p,{children:["The scheduled data backup runs on every Friday at 23:45PM by default. This can be modified by editing the cronSchedule field in all values.yaml files located in ",(0,s.jsx)(n.code,{children:"backup-restore/helmCharts/<release_name>/"})," with the exception of common-lib."]}),"\n",(0,s.jsx)(n.p,{children:"All the performed backups are offline backups,therefore Virtalis Hub will be unavailable for that period as a number of databases have to be taken down."}),"\n",(0,s.jsx)(n.p,{children:"Create an AWS bucket with the name \u201chub-restic\u201d by following the same guide from the Velero section."}),"\n",(0,s.jsx)(n.p,{children:"Replace the keys and create a secret containing the hub-restic bucket credentials:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl create secret generic hub-restic-bucket-creds \\\r\n-n \"$HUB_NAMESPACE\" \\\r\n--from-literal='AWS_ACCESS_KEY'='<ACCESS_KEY>' \\\r\n--from-literal='AWS_SECRET_KEY'='<SECRET_KEY>'\n"})}),"\n",(0,s.jsx)(n.p,{children:"If you instead opted in to deploy an s3 bucket on the same cluster, run this instead:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'kubectl create secret generic hub-restic-bucket-creds \\\r\n-n "$HUB_NAMESPACE" \\\r\n--from-literal=\'AWS_ACCESS_KEY\'=$(kubectl get secret hub-s3-backup \\\r\n-n hub-backup -o jsonpath="{.data.access-key}" | base64 --decode) \\\r\n--from-literal=\'AWS_SECRET_KEY\'=$(kubectl get secret hub-s3-backup \\\r\n-n hub-backup -o jsonpath="{.data.secret-key}" | base64 --decode)\n'})}),"\n",(0,s.jsx)(n.p,{children:"Export the address of the hub-restic bucket:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"export REPO_URL=s3:$S3_BUCKET_PROTOCOL://\\\r\n$S3_BUCKET_ADDRESS:$S3_BUCKET_PORT/hub-restic\n"})}),"\n",(0,s.jsx)(n.p,{children:"Run the installation:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"./install-backup-restore.sh\n"})}),"\n",(0,s.jsx)(n.p,{children:"Check if all the -init-repository- jobs have completed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl get pods -n $HUB_NAMESPACE | grep init-repository\n"})}),"\n",(0,s.jsx)(n.p,{children:"Query the list of repositories:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl get repository -n $HUB_NAMESPACE\n"})}),"\n",(0,s.jsx)(n.p,{children:"The output should look something like this with the status of all repositories showing as Initialized:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"NAME                    STATUS        SIZE   CREATIONDATE\r\nartifact-binary-store   Initialized   0B     2021-03-01T10:21:53Z\r\nartifact-store          Initialized   0B     2021-03-01T10:21:57Z\r\njob-db                  Initialized   0B     2021-03-01T10:21:58Z\r\nkeycloak-db             Initialized   0B     2021-03-01T10:21:58Z\r\nvrdb-binary-store       Initialized   0B     2021-03-01T10:21:58Z\r\nvrdb-store              Initialized   0B     2021-03-01T10:22:00Z\n"})}),"\n",(0,s.jsx)(n.p,{children:"Once you are happy to move on, delete the completed job pods:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl delete jobs -n $HUB_NAMESPACE -l app=backup-restore-init-repository\n"})}),"\n",(0,s.jsx)(n.p,{children:"Trigger a manual backup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"./trigger-database-backup.sh\n"})}),"\n",(0,s.jsx)(n.p,{children:"After a while, all the -triggered-backup- jobs should show up as Completed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'kubectl get pods -n "$HUB_NAMESPACE" | grep triggered-backup\n'})}),"\n",(0,s.jsx)(n.p,{children:"Query the list of snapshots:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'kubectl get snapshot -n "$HUB_NAMESPACE"\n'})}),"\n",(0,s.jsx)(n.p,{children:"The output should look something like this with the status of all snapshots showing as Completed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"NAME                       STATUS      ID       CREATIONDATE\r\nartifact-binary-store...   Completed   62e...   2021...\r\nartifact-store-neo4j-...   Completed   6ae...   2021...\r\njob-db-mysql-master-1...   Completed   944...   2021...\r\nkeycloak-db-mysql-mas...   Completed   468...   2021...\r\nvrdb-binary-store-min...   Completed   729...   2021...\r\nvrdb-store-neo4j-core...   Completed   1c2...   2021...\n"})}),"\n",(0,s.jsx)(n.p,{children:"Once you are happy to move on, delete the completed job pods:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl delete jobs -n $HUB_NAMESPACE -l app=backup-restore-triggered-backup\n"})}),"\n",(0,s.jsx)(n.h2,{id:"triggering-a-manual-backup",children:"Triggering a Manual Backup"}),"\n",(0,s.jsx)(n.p,{children:"Consider scheduling system downtime and scaling down the ingress to prevent people from accessing the server during the backup procedure."}),"\n",(0,s.jsx)(n.p,{children:"Note down the replica count for nginx before scaling it down:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl get deploy -n ingress-nginx \r\nexport NGINX_REPLICAS=<CURRENT_REPLICA_COUNT>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Scale down the nginx ingress service:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl scale deploy --replicas=0 ingress-nginx-ingress-controller \\\r\n-n ingress-nginx\n"})}),"\n",(0,s.jsx)(n.p,{children:"Create a cluster resource level backup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'velero backup create cluster-backup-$(date +"%m-%d-%Y") \\\r\n--storage-location=hub-velero --include-namespaces $HUB_NAMESPACE\n'})}),"\n",(0,s.jsx)(n.p,{children:"Check the status of the velero backup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"watch -n2 velero backup get\n"})}),"\n",(0,s.jsx)(n.p,{children:"Create a database level backup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"./trigger-database-backup.sh\n"})}),"\n",(0,s.jsx)(n.p,{children:"Check the status of the database backup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'watch -n2 kubectl get snapshot -n "$HUB_NAMESPACE"\n'})}),"\n",(0,s.jsx)(n.p,{children:"Once you are happy to move on, delete the completed job pods:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl delete jobs -n $HUB_NAMESPACE -l app=backup-restore-triggered-backup\n"})}),"\n",(0,s.jsx)(n.h2,{id:"restoring-data",children:"Restoring Data"}),"\n",(0,s.jsx)(n.h3,{id:"restoration-plan",children:"Restoration Plan"}),"\n",(0,s.jsx)(n.p,{children:"Plan your restoration by gathering a list of the snapshot IDs you will be restoring from and export them."}),"\n",(0,s.jsx)(n.p,{children:"Begin by querying the list of repositories:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'kubectl get repo -n "$HUB_NAMESPACE"\r\nNAME                    STATUS        SIZE   CREATIONDATE\r\nartifact-binary-store   Initialized   12K    2021-07-02T12:03:26Z\r\nartifact-store          Initialized   527M   2021-07-02T12:03:29Z\r\ncomment-db              Initialized   180M   2021-07-02T12:03:37Z\r\njob-db                  Initialized   181M   2021-07-02T12:03:43Z\r\nkeycloak-db             Initialized   193M   2021-07-02T12:03:43Z\r\nvrdb-binary-store       Initialized   12K    2021-07-02T12:03:46Z\r\nvrdb-store              Initialized   527M   2021-07-02T12:02:44Z\n'})}),"\n",(0,s.jsx)(n.p,{children:"Run a dry run of the restore script to gather a list of the variables you can export:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"DRY_RUN=true ./trigger-database-restore.sh\n"})}),"\n",(0,s.jsx)(n.p,{children:"Sample output:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Error: ARTIFACT_BINARY_STORE_RESTORE_ID has not been exported. Please run 'kubectl get snapshot -n develop -l repository=artifact-binary-store' to see a list of available snapshots.\r\nError: ARTIFACT_STORE_RESTORE_ID has not been exported. Please run 'kubectl get snapshot -n develop -l repository=artifact-store'...\r\n...\n"})}),"\n",(0,s.jsx)(n.p,{children:"Query available snapshots or use the commands returned in the output above to query by specific repositories:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'kubectl get snapshot -n "$HUB_NAMESPACE"\n'})}),"\n",(0,s.jsx)(n.p,{children:"This should return a list of available snapshots:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"NAME                            STATUS      ID       CREATIONDATE\r\nartifact-binary-store-mini...   Completed   4a2...   2021-07-0...\r\nartifact-store-neo4j-core-...   Completed   41d...   2021-07-0...\r\ncomment-db-mysql-master-16...   Completed   e72...   2021-07-0...\r\njob-db-mysql-master-162522...   Completed   eb5...   2021-07-0...\r\nkeycloak-db-mysql-master-1...   Completed   919...   2021-07-0...\r\nvrdb-binary-store-minio-16...   Completed   cf0...   2021-07-0...\r\nvrdb-store-neo4j-core-1625...   Completed   08d...   2021-07-0...\r\nIt\u2019s strongly advised to restore all the backed-up data using snapshots from the same day to avoid data corruption.\n"})}),"\n",(0,s.jsx)(n.p,{children:"Note down the replica count for nginx before scaling it down:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl get deploy -n ingress-nginx\r\nexport NGINX_REPLICAS=<CURRENT_REPLICA_COUNT>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Scale down the nginx ingress service to prevent people from accessing Virtalis Hub during the restoration process:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl scale deploy --replicas=0 ingress-nginx-ingress-controller \\\r\n-n ingress-nginx\n"})}),"\n",(0,s.jsx)(n.h3,{id:"run-the-restore-script",children:"Run the Restore Script"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"./trigger-database-restore.sh\n"})}),"\n",(0,s.jsx)(n.p,{children:"Get list of backups created with velero:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"velero backup get\n"})}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"NAME            STATUS      ERRORS   WARNINGS   CREATED     EXPIRES   STORAGE LOCATION   SELECTOR\r\ntest-backup-1   Completed   0        0          2022-0...   29d       hub-velero       <none>\r\ntest-backup-2   Completed   0        0          2022-0...   29d       hub-velero       <none>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Restore:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"velero restore create --from-backup <backup name>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Unset exported restore id\u2019s:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'charts=( $(ls backup-restore/helmCharts/) ); \\\r\nfor chart in "${charts[@]}"; do if [ $chart == "common-lib" ]; \\\r\nthen continue; fi; id_var="$(echo ${chart^^} | \\\r\nsed \'s/-/_/g\')_RESTORE_ID"; unset ${id_var}; done\n'})}),"\n",(0,s.jsx)(n.p,{children:"After a while, all the -triggered-restore- jobs should show up as Completed:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'kubectl get pods -n "$HUB_NAMESPACE" | grep triggered-restore\n'})}),"\n",(0,s.jsx)(n.p,{children:"Once you are happy to move on, delete the completed job pods:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl delete jobs -n $HUB_NAMESPACE \\\r\n-l app=backup-restore-triggered-restore\n"})}),"\n",(0,s.jsx)(n.p,{children:"Watch and wait for all pods that are running to be Ready:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'watch -n2 kubectl get pods -n "$HUB_NAMESPACE"\n'})}),"\n",(0,s.jsx)(n.p,{children:"Scale back nginx:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'kubectl scale deploy --replicas="$NGINX_REPLICAS" \\\r\ningress-nginx-ingress-controller -n ingress-nginx\n'})}),"\n",(0,s.jsx)(n.h2,{id:"pruning-backups",children:"Pruning Backups"}),"\n",(0,s.jsx)(n.h3,{id:"velero",children:"Velero"}),"\n",(0,s.jsx)(n.p,{children:"Get list of backups created with velero:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"velero backup get\n"})}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"NAME            STATUS      ERRORS   WARNINGS   CREATED     EXPIRES   STORAGE LOCATION   SELECTOR\r\ntest-backup-1   Completed   0        0          2022-0...   29d       hub-velero       <none>\r\ntest-backup-2   Completed   0        0          2022-0...   29d       hub-velero       <none>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Delete a single backup:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"velero backup delete <name>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"velero backup delete test-backup-1\n"})}),"\n",(0,s.jsx)(n.p,{children:"Restic\r\nGet list of Hub backups:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl get snapshot -n $HUB_NAMESPACE\n"})}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"artifact-binary-store-minio-1642502735    Completed   5daa1580   2022-01-18T10:45:35Z\r\nartifact-binary-store-minio-1642512232    Completed   b1fb6a15   2022-01-18T13:23:52Z\r\nartifact-binary-store-minio-1642512501    Completed   764c989e   2022-01-18T13:28:21Z\r\nartifact-store-neo4j-core-1642502736      Completed   f8233016   2022-01-18T10:45:36Z\r\nartifact-store-neo4j-core-1642512234      Completed   df2606b1   2022-01-18T13:23:54Z\r\nartifact-store-neo4j-core-1642512502      Completed   a9d9470b   2022-01-18T13:28:22Z\r\ncomment-db-mysql-master-1642502737        Completed   da0de6a7   2022-01-18T10:45:37Z\r\ncomment-db-mysql-master-1642512237        Completed   37a860e4   2022-01-18T13:23:57Z\r\ncomment-db-mysql-master-1642512503        Completed   d5e04e5e   2022-01-18T13:28:23Z\r\njob-db-mysql-master-1642502739            Completed   51db2aa5   2022-01-18T10:45:39Z\r\njob-db-mysql-master-1642512235            Completed   40c5fae1   2022-01-18T13:23:55Z\r\njob-db-mysql-master-1642512505            Completed   dbc0921e   2022-01-18T13:28:25Z\r\nkeycloak-db-mysql-master-1642502742       Completed   70ab969a   2022-01-18T10:45:42Z\r\nkeycloak-db-mysql-master-1642512235       Completed   6df99e96   2022-01-18T13:23:55Z\r\nkeycloak-db-mysql-master-1642512506       Completed   25c93be7   2022-01-18T13:28:26Z\r\nproduct-tree-db-mysql-master-1642502740   Completed   ba4edb53   2022-01-18T10:45:40Z\r\nproduct-tree-db-mysql-master-1642512238   Completed   47880e3b   2022-01-18T13:23:58Z\r\nproduct-tree-db-mysql-master-1642512504   Completed   378dd1e1   2022-01-18T13:28:24Z\r\nvrdb-binary-store-minio-1642502746        Completed   c7109c6b   2022-01-18T10:45:46Z\r\nvrdb-binary-store-minio-1642512247        Completed   18f03082   2022-01-18T13:24:07Z\r\nvrdb-binary-store-minio-1642512510        Completed   5c47d40c   2022-01-18T13:28:30Z\r\nvrdb-store-neo4j-core-1642502748          Completed   bd692195   2022-01-18T10:45:48Z\r\nvrdb-store-neo4j-core-1642512241          Completed   df6cbaf9   2022-01-18T13:24:01Z\r\nvrdb-store-neo4j-core-1642512510          Completed   89ae8fcc   2022-01-18T13:28:30Z\n"})}),"\n",(0,s.jsx)(n.p,{children:"Prune backups based on a restic policy."}),"\n",(0,s.jsx)(n.p,{children:"Learn more about the different policies here: Removing backup snapshots \u2014 restic 0.16.4 documentation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'PRUNE_FLAG="<policy>" ./trigger-database-backup-prune.sh\n'})}),"\n",(0,s.jsx)(n.p,{children:"Example:"}),"\n",(0,s.jsx)(n.p,{children:"Keep the latest snapshot and delete everything else:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'PRUNE_FLAG="--keep-last 1" ./trigger-database-backup-prune.sh\n'})}),"\n",(0,s.jsx)(n.p,{children:"After:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"NAME                                      STATUS      ID         CREATIONDATE\r\nartifact-binary-store-minio-1642512501    Completed   764c989e   2022-01-18T13:28:21Z\r\nartifact-store-neo4j-core-1642512502      Completed   a9d9470b   2022-01-18T13:28:22Z\r\ncomment-db-mysql-master-1642512503        Completed   d5e04e5e   2022-01-18T13:28:23Z\r\njob-db-mysql-master-1642512505            Completed   dbc0921e   2022-01-18T13:28:25Z\r\nkeycloak-db-mysql-master-1642512506       Completed   25c93be7   2022-01-18T13:28:26Z\r\nproduct-tree-db-mysql-master-1642512504   Completed   378dd1e1   2022-01-18T13:28:24Z\r\nvrdb-binary-store-minio-1642512510        Completed   5c47d40c   2022-01-18T13:28:30Z\r\nvrdb-store-neo4j-core-1642512510          Completed   89ae8fcc   2022-01-18T13:28:30Z\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>a});var t=r(96540);const s={},o=t.createContext(s);function i(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);