"use strict";(self.webpackChunkvirtalis_docs=self.webpackChunkvirtalis_docs||[]).push([[1363],{52337:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"virtalis-hub-system-admin/setup/update","title":"Update to Latest Version","description":"This section describes how to update your Virtalis Hub installation to the latest version.","source":"@site/docs/virtalis-hub-system-admin/setup/update.mdx","sourceDirName":"virtalis-hub-system-admin/setup","slug":"/virtalis-hub-system-admin/setup/update","permalink":"/virtalis-hub-system-admin/setup/update","draft":false,"unlisted":false,"editUrl":"https://github.com/virtalis/docs/tree/master/docs/virtalis-hub-system-admin/setup/update.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"virtalisHubSystemAdminSidebar","previous":{"title":"Deploy to a Kubernetes Cluster","permalink":"/virtalis-hub-system-admin/setup/deploy-kubernetes"},"next":{"title":"Deploy the Monitoring Service Stack","permalink":"/virtalis-hub-system-admin/setup/deploy-monitoring"}}');var i=t(74848),r=t(28453);const l={sidebar_position:3},o="Update to Latest Version",a={},c=[{value:"Set Up Variables",id:"set-up-variables",level:2},{value:"Download Installation Files",id:"download-installation-files",level:2},{value:"Installation",id:"installation",level:2},{value:"Licence Key",id:"licence-key",level:3},{value:"Set Up Variables",id:"set-up-variables-1",level:4},{value:"\u200dUpdate Secrets",id:"update-secrets",level:4}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"update-to-latest-version",children:"Update to Latest Version"})}),"\n",(0,i.jsx)(n.p,{children:"This section describes how to update your Virtalis Hub installation to the latest version."}),"\n",(0,i.jsx)(n.h2,{id:"set-up-variables",children:"Set Up Variables"}),"\n",(0,i.jsx)(n.p,{children:"Export the following variables:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'export HUB_NAMESPACE=hub\r\nexport HUB_VERSION=2024.1.0\r\nexport SKIP_MIGRATIONS=0\r\nexport ACR_REGISTRY_NAME=$(kubectl get secret hub-install-config -n $HUB_NAMESPACE  -o json | jq ".data.ACR_REGISTRY_NAME" -r | base64 -d)\r\nexport ACR_USERNAME=$(kubectl get secret hub-install-config -n $HUB_NAMESPACE  -o json | jq ".data.ACR_USERNAME" -r | base64 -d)\r\nexport ACR_PASSWORD=$(kubectl get secret hub-install-config -n $HUB_NAMESPACE  -o json | jq ".data.ACR_PASSWORD" -r | base64 -d)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"download-installation-files",children:"Download Installation Files"}),"\n",(0,i.jsx)(n.p,{children:"Log in with Oras:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'oras login "${ACR_REGISTRY_NAME}".azurecr.io \\\r\n--username "${ACR_USERNAME}" \\\r\n-p "${ACR_PASSWORD}"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Make a backup of the old installation files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo mv /home/root/Hub /home/root/.Hub\n"})}),"\n",(0,i.jsx)(n.p,{children:"Make a directory to store the installation files:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo mkdir -p /home/root/Hub && \\\r\ncd /home/root/Hub && \\\r\nsudo chown $(whoami) /home/root/Hub\n"})}),"\n",(0,i.jsx)(n.p,{children:"Pull the Kubernetes deployment file archive from the Virtalis registry and unzip it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'oras pull "${ACR_REGISTRY_NAME}".azurecr.io/misc/k8s:$HUB_VERSION && tar -zxvf k8s.tar.gz\n'})}),"\n",(0,i.jsx)(n.p,{children:"Make the installation scripts executable:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"cd k8s && sudo chmod +x *.sh && sudo chmod +x misc/keycloak/migration/*.sh\n"})}),"\n",(0,i.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,i.jsx)(n.p,{children:"Load the previous configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:". ./load-install-config.sh\n"})}),"\n",(0,i.jsx)(n.p,{children:"Create the secrets:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"./create-secrets.sh\n"})}),"\n",(0,i.jsx)(n.p,{children:"Deploy Virtalis Hub:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"./deploy.sh\n"})}),"\n",(0,i.jsx)(n.h3,{id:"licence-key",children:"Licence Key"}),"\n",(0,i.jsx)(n.p,{children:"This section describes how to replace the currently installed licence key with a new one."}),"\n",(0,i.jsxs)(n.p,{children:["This section assumes that you have already installed Virtalis Hub and your shell is in the directory containing the files that were downloaded during the installation, this is usually stored in the home directory, for example ",(0,i.jsx)(n.code,{children:"/home/root/Hub/k8s"})]}),"\n",(0,i.jsx)(n.h4,{id:"set-up-variables-1",children:"Set Up Variables"}),"\n",(0,i.jsx)(n.p,{children:"Export the following variables:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"export HUB_NAMESPACE=hub\n"})}),"\n",(0,i.jsx)(n.p,{children:"Load previous configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:". ./load-install-config.sh\n"})}),"\n",(0,i.jsx)(n.p,{children:"Substitute and export the following variables:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"export hub_licence__key=<hub licence xml snippet>\r\nexport hub_licence__signature=<hub licence signature>\n"})}),"\n",(0,i.jsx)(n.h4,{id:"update-secrets",children:"\u200dUpdate Secrets"}),"\n",(0,i.jsx)(n.p,{children:"Run a script:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"./create-secrets.sh\r\n./install-hub.sh \r\nkubectl get secret hub-install-config \\\r\n-n $HUB_NAMESPACE -o json | jq -r '.data.hub_licence__key=\"'\\\r\n$(echo -n $hub_licence__key | base64 -w 0 | tr -d '\\n')'\"' \\\r\n| kubectl apply -f -\r\n \r\nkubectl get secret hub-install-config \\\r\n-n $HUB_NAMESPACE -o json | jq -r '.data.hub_licence__signature=\"'\\\r\n$(echo -n $hub_licence__signature | base64 -w 0 | tr -d '\\n')'\"' \\\r\n| kubectl apply -f -\n"})}),"\n",(0,i.jsx)(n.p,{children:"Gracefully restart any running pods for the two services below by doing a rolling restart:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kubectl rollout restart deploy artifact-access-api -n $HUB_NAMESPACE\r\nkubectl rollout restart deploy project-management-api -n $HUB_NAMESPACE\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>o});var s=t(96540);const i={},r=s.createContext(i);function l(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);